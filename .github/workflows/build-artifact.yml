name: Build & Upload
env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1
on:
  workflow_dispatch:
  workflow_call:
    secrets:
      ENVS:
        required: false
      DOCKER_PY_REVANCED_SECRETS:
        required: false
      REDDIT_CLIENT_ID:
        required: false
      WEBDAV_ADDRESS:
        required: false
      WEBDAV_USERNAME:
        required: false
      WEBDAV_PASSWORD:
        required: false
    inputs:
      CI_TEST:
        required: false
        type: boolean
        default: false
      COMMIT_CHANGELOG:
        type: boolean
        required: false
        default: true
      DEBUG_ENABLED:
        type: boolean
        description: 'Run the build with tmate debugging enabled.'
        required: false
        default: false
      PREFERRED_PATCH_APPS:
        description: "Apps to be patched. Overrides any env set"
        required: false
        type: string

jobs:
  build-apk:
    permissions: write-all
    name: APK Build
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Check out Git repository
        uses: actions/checkout@main

      - name: Update Env for custom build
        run: |
          # 1. ì‹œí¬ë¦¿ ë‚´ìš©ì„ .env íŒŒì¼ì— ë³‘í•©
          echo "${{ secrets.ENVS }}" >> .env
          echo "GITHUB_REPOSITORY=${{ github.repository }}" >> .env
          echo "${{ secrets.DOCKER_PY_REVANCED_SECRETS }}" >> .env
          
          # 2. .env íŒŒì¼ì„ ì½ì–´ ì£¼ì„ê³¼ ë¹ˆ ì¤„ì„ ì œì™¸í•œ ëª¨ë“  ë³€ìˆ˜ë¥¼ ì‹œìŠ¤í…œ í™˜ê²½ ë³€ìˆ˜ë¡œ ë“±ë¡
          if [ -f .env ]; then
            sed -i 's/\r$//' .env # ìœˆë„ìš° ì¤„ë°”ê¿ˆ ì œê±°
            grep -v '^#' .env | grep -v '^[[:space:]]*$' >> $GITHUB_ENV
            echo "âœ… Loaded variables from .env to GITHUB_ENV"
          fi

          # 3. ë¡œë“œëœ ë³€ìˆ˜ í™•ì¸ìš© ë¡œê·¸ ì¶œë ¥ (ë³´ì•ˆìƒ ê°’ì˜ ì¼ë¶€ëŠ” ë§ˆìŠ¤í‚¹ë  ìˆ˜ ìˆìŒ)
          echo "--- Loaded Environment Variables ---"
          env | grep -E "PATCH_APPS|VERSION" | sort
          echo "------------------------------------"

      # --- WebDAV ë¡œì§ (PATCH_APPS ê¸°ë°˜ ë™ì  ë²„ì „ ì°¸ì¡°) ---
      - name: Download APKs from WebDAV
        run: |
          mkdir -p apks
          
          # 1. PATCH_APPSì—ì„œ ì²« ë²ˆì§¸ ì•± ì´ë¦„ì„ ë”°ì™€ì„œ ë²„ì „ ë³€ìˆ˜ëª… ë™ì  ìƒì„±
          # ì˜ˆ: youtube_extended_red_inotia00 -> YOUTUBE_EXTENDED_RED_INOTIA00_VERSION
          FIRST_APP=$(echo $PATCH_APPS | cut -d',' -f1 | xargs)
          VERSION_VAR_NAME="${FIRST_APP^^}_VERSION"
          
          # 2. Bash ê°„ì ‘ ì°¸ì¡°(`${!VAR}`)ë¥¼ ì‚¬ìš©í•˜ì—¬ í•´ë‹¹ ë³€ìˆ˜ì˜ ì‹¤ì œ ê°’ì„ ê°€ì ¸ì˜´
          VERSION="${!VERSION_VAR_NAME}"
          
          echo "Apps to Build: $PATCH_APPS"
          echo "Dynamic Version Key: $VERSION_VAR_NAME"
          echo "Detected Version Value: $VERSION"

          if [ -z "$VERSION" ]; then
            echo "::error::ë³€ìˆ˜ $VERSION_VAR_NAME ë¥¼ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ ê°’ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤."
            exit 1
          fi

          # 3. WebDAV ì„œë²„ì—ì„œ íŒŒì¼ ëª©ë¡ ì¡°íšŒ
          FILE_LIST=$(curl -s -u "${{ secrets.WEBDAV_USERNAME }}:${{ secrets.WEBDAV_PASSWORD }}" \
            -X PROPFIND --header "Depth: 1" \
            "${{ secrets.WEBDAV_ADDRESS }}/data/ìë£Œëª¨ìŒ/ì•±ëª¨ìŒ/Youtube/apks/")
          
          # 4. ì •ê·œì‹ìœ¼ë¡œ ë²„ì „ì— ë§ëŠ” ì›ë³¸ APK ì°¾ê¸°
          TARGET_FILE=$(echo "$FILE_LIST" | grep -oE "com\.google\.android\.youtube_[^<]*${VERSION}[^<]*\.apk" | head -1)
          
          if [ -z "$TARGET_FILE" ]; then
            echo "::error::WebDAVì—ì„œ ë²„ì „ $VERSION ì— ë§ëŠ” APKë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          fi

          # 5. ì›ë³¸ íŒŒì¼ ë‹¤ìš´ë¡œë“œ
          curl -u "${{ secrets.WEBDAV_USERNAME }}:${{ secrets.WEBDAV_PASSWORD }}" \
            -L -o "base.apk" \
            "${{ secrets.WEBDAV_ADDRESS }}/data/ìë£Œëª¨ìŒ/ì•±ëª¨ìŒ/Youtube/apks/$TARGET_FILE"

          # 6. PATCH_APPS ë¦¬ìŠ¤íŠ¸ë¥¼ ìˆœíšŒí•˜ë©° í™•ì¥ì ì—†ì´ ë³µì‚¬ (ë¹Œë” ê·œì¹™)
          IFS=',' read -ra ADDR <<< "$PATCH_APPS"
          DOWNLOADED_LIST=""
          for APP in "${ADDR[@]}"; do
            APP=$(echo $APP | xargs)
            if [ -n "$APP" ] && [[ $APP == youtube* ]]; then
              echo "Preparing: apks/$APP"
              cp "base.apk" "apks/$APP"
              DOWNLOADED_LIST="${DOWNLOADED_LIST},${APP}"
            fi
          done
          
          # 7. EXISTING_DOWNLOADED_APKS ë“±ë¡
          echo "EXISTING_DOWNLOADED_APKS=${DOWNLOADED_LIST#,}" >> $GITHUB_ENV
          echo "EXISTING_DOWNLOADED_APKS=${DOWNLOADED_LIST#,}" >> .env
      # --- WebDAV ë¡œì§ ì¢…ë£Œ ---

      - name: Setup python
        uses: actions/setup-python@main
        with:
          python-version: '3.x'

      - name: Install Requirements
        if: ${{ inputs.PREFERRED_PATCH_APPS }}
        env:
          PREFERRED_PATCH_APPS: ${{ inputs.PREFERRED_PATCH_APPS }}
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Override Patch apps
        if: ${{ inputs.PREFERRED_PATCH_APPS }}
        env:
          PREFERRED_PATCH_APPS: ${{ inputs.PREFERRED_PATCH_APPS }}
        run: |
          python -m scripts.prefered_apps

      - name: Inject Reddit Client ID
        env:
          REDDIT_CLIENT_ID: ${{ secrets.REDDIT_CLIENT_ID }}
        if: env.REDDIT_CLIENT_ID != null
        run: |
          client_id="${REDDIT_CLIENT_ID}"
          path="apks/options.json"
          json_data=$(cat "${path}")

          new_object='{
          "patchName": "Spoof client",
          "options": [
            {
              "key": "client-id",
              "value": "'${client_id}'"
            }
          ]
          }'
          # Check if an object with the patchName "Spoof client" already exists
          existing_object_index=$(echo "${json_data}" | jq 'map(.patchName) | index("Spoof client")')
          echo "${existing_object_index}"
          if [[ ${existing_object_index} != "null" ]]; then
            echo "Patch entry already exists. Overriding client ID in it."
            updated_json=$(echo "${json_data}" | jq ".[${existing_object_index}].options[0].value = \"${client_id}\"")
          else
            echo "Patch entry doesn't exists. Adding new entry."
            updated_json=$(echo "${json_data}" | jq ". += [${new_object}]")
          fi
          echo "${updated_json}" > "${path}"


      - name: Setup tmate session
        uses: mxschmitt/action-tmate@master
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.DEBUG_ENABLED }}
        with:
          detached: true

      - name: Build Revanced APKs
        if: ${{ true && !inputs.DEBUG_ENABLED }}
        run: |
          if [[ "${{ inputs.CI_TEST }}" =~ ^(true|True|1)$ ]]; then
              echo "In CI Testing. Using local compose file."
              docker compose -f docker-compose-local.yml build --no-cache
              docker compose -f docker-compose-local.yml up
          else
              echo "Using Prod compose file."              
              docker compose -f docker-compose-local.yml build --no-cache
              docker compose -f docker-compose-local.yml up
          fi

      - name: Verify at least one APK was patched
        if: ${{ true && !inputs.DEBUG_ENABLED }}
        run: |
          # Count patched APKs (excluding Microg which is a dependency, not a patched app)
          patched_count=$(find apks -maxdepth 1 -name "*-output.apk" ! -name "Revanced-Microg-output.apk" -type f 2>/dev/null | wc -l)
          echo "Found $patched_count patched APK(s)"

          if [ "$patched_count" -eq 0 ]; then
            echo "::error::No APKs were successfully patched. Build failed."
            exit 1
          fi

          echo "âœ… Successfully patched $patched_count APK(s):"
          find apks -maxdepth 1 -name "*-output.apk" ! -name "Revanced-Microg-output.apk" -type f

      - name: Ensure changelog files exist
        if: ${{ true && !inputs.DEBUG_ENABLED }}
        run: |
          # Create empty changelog files if they don't exist (fallback for failed builds)
          if [ ! -f changelog.md ]; then
            echo "| Resource Name | Version | Changelog | Published On | Build By|" > changelog.md
            echo "|---------------|---------|-----------|--------------|---------|" >> changelog.md
          fi
          if [ ! -f changelog.json ]; then
            echo "{}" > changelog.json
          fi
          if [ ! -f updates.json ]; then
            echo "{}" > updates.json
          fi

      - name: Upload Build APKS
        uses: actions/upload-artifact@main
        if: ${{ true && !inputs.DEBUG_ENABLED }}
        with:
          name: Built-APKs
          path: |
            changelog.md
            changelog.json
            updates.json
            apks/*-output.apk
            apks/VancedMicroG.apk
          if-no-files-found: error

      - name: Commit Update file
        if: ${{ inputs.COMMIT_CHANGELOG && !inputs.CI_TEST}}
        uses: stefanzweifel/git-auto-commit-action@master
        with:
          branch: changelogs
          skip_checkout: true
          file_pattern: 'changelog.md changelog.json updates.json'
          commit_message: ğŸš€New Build
          push_options: '--force'
